#!/bin/sh

set -e

sudo chmod 0666 /dev/input/event* /dev/uinput

ROOT=$(dirname "${0%/*}")
rbindkeys="$ROOT/ruby/bin/ruby -I$ROOT/app/lib -rrbconfig $ROOT/app/bin/rbindkeys.rb"

case $(basename $0) in
    rbindkeys)
        if [ -z "$*" ]; then
            echo '         ***** rbindkeys shell wrapper *****         '
            echo
            echo "Run rbindkeys 'Keyboard device description' to start."
            echo "e.g. rbindkeys 'AT Translated Set 2 keyboard'"
            echo
            echo 'use rbindkeys -l for available keybard device.'
            echo 'append --daemon as argument will start as a daemon.'
            echo
            echo 'For boot autorun with no sudo password, you need add'
            echo 'current user to /etc/sudoers with following command:'
            echo "echo $CURRENT_USER ALL=(ALL) NOPASSWD: ALL |sudo tee -a /etc/sudoers"
            echo
            echo 'default config is $HOME/.rbindkeys.rb'
            echo
            echo 'You can run original rbindkeys with: rbindkeys.rb [OPTION]'
            echo
            exit
        fi

        if [ "$*" == "-l" ]; then
            $rbindkeys -l
            exit
        fi

        input_device=$($rbindkeys -l |fgrep -e "$1" |cut -d':' -f1)

        if [ "$input_device" ]; then
            if [ "$2" == '--daemon' ]; then
                tmpdir=$(dirname $(mktemp -u))
                (exec $rbindkeys $input_device &> $tmpdir/rbindkeys.log &)
            else
                $rbindkeys $input_device
            fi
        else
            echo
            echo "Keyboard description \`$1' is not exist."
            echo
            echo 'All available input device.'
            echo
            $0 -l
        fi
        ;;
    rbindkeys.rb)
        $rbindkeys "$@"
esac
